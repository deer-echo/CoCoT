version: '3.8'

services:
  qwen2vl-datagen:
    build: .
    image: qwen2vl-datagen:latest
    container_name: qwen2vl-container
    
    # GPUæ”¯æŒ
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    
    # ç¯å¢ƒå˜é‡
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - CUDA_VISIBLE_DEVICES=0,1,2,3
      - PYTHONUNBUFFERED=1
    
    # å·æŒ‚è½½
    volumes:
      - .:/workspace
      - ./models:/workspace/models  # æ¨¡å‹æ–‡ä»¶ç›®å½•
      - ./data:/workspace/data      # æ•°æ®æ–‡ä»¶ç›®å½•
      - ./output:/workspace/output  # è¾“å‡ºç›®å½•
    
    # ç«¯å£æ˜ å°„ï¼ˆå¦‚æœéœ€è¦Jupyterç­‰æœåŠ¡ï¼‰
    ports:
      - "8888:8888"  # Jupyter Lab
      - "6006:6006"  # TensorBoard
    
    # å·¥ä½œç›®å½•
    working_dir: /workspace
    
    # äº¤äº’å¼ç»ˆç«¯
    stdin_open: true
    tty: true
    
    # å¯åŠ¨å‘½ä»¤
    command: >
      bash -c "
        source activate qwen2vl &&
        python check_environment.py &&
        echo 'ğŸš€ Qwen2-VLæ•°æ®ç”Ÿæˆç³»ç»Ÿå·²å°±ç»ª!' &&
        echo 'è¿è¡Œ python quick_start.py å¼€å§‹ç”Ÿæˆæ•°æ®' &&
        /bin/bash
      "

# ä½¿ç”¨æ–¹æ³•:
# 1. æ„å»ºå¹¶å¯åŠ¨: docker-compose up --build
# 2. è¿›å…¥å®¹å™¨: docker-compose exec qwen2vl-datagen bash
# 3. åœæ­¢æœåŠ¡: docker-compose down
